//+------------------------------------------------------------------+
//|                                                 SuperTrendEA.mq5 |
//|                                      Generated by Gemini AI      |
//|                                                                  |
//|  Description: SuperTrend Entry with 1:1 SL lock at 1:2 RR        |
//+------------------------------------------------------------------+
#property copyright "Gemini AI"
#property link      ""
#property version   "1.00"

#include <Trade\Trade.mqh>

//--- Inputs
input double InpLotSize = 0.1;        // Lot Size
input int    InpSTPeriod = 10;        // SuperTrend Period
input double InpSTMultiplier = 3.0;   // SuperTrend Multiplier
input int    InpMagicNum = 123456;    // Magic Number

//--- Define Indicator Name (Must match the file in your Indicators folder)
#define INDICATOR_NAME "SuperTrend" 

//--- Global Variables
CTrade trade;
int handleST;
double stBuffer[]; // Buffer for SuperTrend Line values

//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
  {
   //--- Initialize the Trade Helper
   trade.SetExpertMagicNumber(InpMagicNum);

   //--- Get handle for SuperTrend Indicator
   // Note: We assume the SuperTrend indicator takes Period and Multiplier as first two inputs
   handleST = iCustom(_Symbol, _Period, INDICATOR_NAME, InpSTPeriod, InpSTMultiplier);

   if(handleST == INVALID_HANDLE)
     {
      Print("Failed to create SuperTrend handle. Make sure '", INDICATOR_NAME, ".ex5' is in Indicators folder.");
      return(INIT_FAILED);
     }

   //--- Set up arrays/buffers
   ArraySetAsSeries(stBuffer, true);

   return(INIT_SUCCEEDED);
  }

//+------------------------------------------------------------------+
//| Expert deinitialization function                                 |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
  {
   IndicatorRelease(handleST);
  }

//+------------------------------------------------------------------+
//| Expert tick function                                             |
//+------------------------------------------------------------------+
void OnTick()
  {
   //--- 1. Manage Open Positions (The 1:2 RR Logic)
   ManagePositions();

   //--- 2. Check for New Entries
   // Only open one trade at a time per symbol for simplicity
   if(PositionsTotal() > 0) return;

   //--- Get Indicator Data
   if(CopyBuffer(handleST, 0, 0, 3, stBuffer) < 3) return; // Buffer 0 usually holds the line value

   //--- Get Price Data
   double close1 = iClose(_Symbol, _Period, 1); // Previous candle close
   double close2 = iClose(_Symbol, _Period, 2); // Candle before previous

   double stVal1 = stBuffer[1]; // SuperTrend value at previous candle
   double stVal2 = stBuffer[2]; // SuperTrend value 2 candles ago

   //--- Buy Signal: Price crosses ABOVE SuperTrend
   // (Candle 2 was below ST, Candle 1 closed above ST)
   if(close2 < stVal2 && close1 > stVal1)
     {
      double sl = stVal1; // Set SL at the SuperTrend line
      trade.Buy(InpLotSize, _Symbol, 0, sl, 0, "ST Buy");
     }

   //--- Sell Signal: Price crosses BELOW SuperTrend
   // (Candle 2 was above ST, Candle 1 closed below ST)
   else if(close2 > stVal2 && close1 < stVal1)
     {
      double sl = stVal1; // Set SL at the SuperTrend line
      trade.Sell(InpLotSize, _Symbol, 0, sl, 0, "ST Sell");
     }
  }

//+------------------------------------------------------------------+
//| Logic to move SL to 1:1 when price hits 1:2 RR                   |
//+------------------------------------------------------------------+
void ManagePositions()
  {
   for(int i = PositionsTotal() - 1; i >= 0; i--)
     {
      ulong ticket = PositionGetTicket(i);
      if(PositionGetString(POSITION_SYMBOL) != _Symbol) continue;
      if(PositionGetInteger(POSITION_MAGIC) != InpMagicNum) continue;

      // Get Position Details
      long type = PositionGetInteger(POSITION_TYPE);
      double openPrice = PositionGetDouble(POSITION_PRICE_OPEN);
      double currentSL = PositionGetDouble(POSITION_SL);
      double currentPrice = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(_Symbol, SYMBOL_BID) : SymbolInfoDouble(_Symbol, SYMBOL_ASK);

      // We need a valid initial SL to calculate Risk. 
      // If SL is 0, we skip (shouldn't happen with this EA).
      if(currentSL == 0) continue;

      double point = SymbolInfoDouble(_Symbol, SYMBOL_POINT);

      if(type == POSITION_TYPE_BUY)
        {
         // 1. Check if we have already moved SL to Breakeven/Profit
         // If SL is higher than Open Price, we are already in "Safe Mode", so stop checking.
         if(currentSL > openPrice) continue;

         // 2. Calculate Initial Risk (R)
         // Risk = Distance between Entry and current SL
         double risk = openPrice - currentSL;
         if(risk <= 0) continue; // Safety check

         // 3. Check if we reached 1:2 Risk-Reward (2 * Risk)
         // Target Profit Distance = 2 * Risk
         double profitDistance = currentPrice - openPrice;

         if(profitDistance >= (2.0 * risk))
           {
            // 4. Move SL to 1:1 (Entry + 1 * Risk)
            double newSL = openPrice + risk;
            
            // Normalize price to prevent errors
            newSL = NormalizeDouble(newSL, _Digits);

            Print("1:2 RR Hit! Moving Buy SL to lock 1:1. New SL: ", newSL);
            trade.PositionModify(ticket, newSL, PositionGetDouble(POSITION_TP));
           }
        }
      else if(type == POSITION_TYPE_SELL)
        {
         // 1. Check if we have already moved SL to Breakeven/Profit
         // If SL is lower than Open Price, we are already in "Safe Mode"
         if(currentSL < openPrice) continue;

         // 2. Calculate Initial Risk (R)
         double risk = currentSL - openPrice;
         if(risk <= 0) continue;

         // 3. Check if we reached 1:2 Risk-Reward
         double profitDistance = openPrice - currentPrice;

         if(profitDistance >= (2.0 * risk))
           {
            // 4. Move SL to 1:1 (Entry - 1 * Risk)
            double newSL = openPrice - risk;
            
            newSL = NormalizeDouble(newSL, _Digits);

            Print("1:2 RR Hit! Moving Sell SL to lock 1:1. New SL: ", newSL);
            trade.PositionModify(ticket, newSL, PositionGetDouble(POSITION_TP));
           }
        }
     }
  }
